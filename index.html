<!DOCTYPE html>

<script src="apikey.js"></script>
<script>
class Bungie {
  constructor() {
    this.auth = {expires: 0, refresh_expires: 0};
    let bungienet = new BungieNet(this);
    this.net = bungienet.build('');
  }

  store(key, data) {
    if (data === null)
      localStorage.removeItem(key);
    else
      localStorage.setItem(key, JSON.stringify(data));
  }

  get(key) {
    let data = localStorage.getItem(key);
    if (data)
      return JSON.parse(data);
  }

  async fetch(path, params, method='GET') {
    let headers = {
        'X-API-Key': API_KEY,
    };
    if (this.auth.expires > Date.now())
      headers['Authorization'] = 'Bearer ' + this.auth.access_token;
    let init = {method, headers};
    if (params) {
      let paramobj = new URLSearchParams();
      for (let [k, v] of Object.entries(params))
        paramobj.append(k, v);
      if (method == 'GET')
        path = `${path}?${paramobj.toString()}`;
      else {
        headers['Content-Type'] = 'application/x-www-form-urlencoded';
        init['body'] = paramobj.toString();
      }
    }
    path = 'https://www.bungie.net/' + path;
    console.log('fetch(%o, %o)', path, init);
    let req = await fetch(path, init);
    return req.json();
  }

  async login() {
    let search = new URLSearchParams(location.search);
    if (search.get('code') && this.get('auth_nonce') &&
        (search.get('state') == this.get('auth_nonce'))) {
      this.store('auth_nonce', null);
      history.replaceState(null, null, '.');
      return this.handleCredentials(await this.net.platform.app.OAuth.token.POST(
          {client_id: CLIENT_ID, grant_type: 'authorization_code', code: search.get('code')}));
    }
    let auth = this.get('auth');
    if (auth)
      this.auth = auth;
    let now = Date.now();
    if (this.auth.expires > now)
      return;
    if (this.auth.refresh_expires > now)
      return this.handleCredentials(await this.net.platform.app.OAuth.token.POST(
          {client_id: CLIENT_ID, grant_type: 'refresh_token', refresh_token: this.auth.refresh_token}));
    let nonce = String(Math.random()).substr(2, 20);
    this.store('auth_nonce', nonce);
    location.replace(`https://www.bungie.net/en/OAuth/Authorize?client_id=${CLIENT_ID}&response_type=code&state=${nonce}`);
    return Promise.reject();
  }

  handleCredentials(data) {
    let now = Date.now();
    data.expires = now + data.expires_in * 1000 - 1000;
    data.refresh_expires = now + data.refresh_expires_in * 1000 - 1000;
    this.auth = data;
    this.store('auth', this.auth);
  }
}


class BungieNet {
  constructor(bungie) {
    this.bungie = bungie;
  }

  build(path) {
    let cache = function() {};
    cache.path = path;
    cache.cache = {};
    return new Proxy(cache, this);
  }

  get(target, name) {
    if (!target.cache[name]) {
      if (/^[A-Z]+$/.test(name))
        target.cache[name] = params => this.bungie.fetch(target.path, params, name);
      else
        target.cache[name] = this.build(`${target.path}${name}/`);
    }
    return target.cache[name];
  }

  apply(target, thisArg, args) {
    return this.get(target, 'GET').apply(thisArg, args);
  }
}


let bungie = new Bungie();

(async function() {

await bungie.login();

let manifest = await bungie.net.platform.destiny2.manifest();
let hashes = {};
for (let hashtype of ['DestinyInventoryBucketDefinition', 'DestinyInventoryItemLiteDefinition'])
  hashes[hashtype] = await fetch(`https://www.bungie.net${manifest.Response.jsonWorldComponentContentPaths.en[hashtype]}`, {credentials: 'omit'}).then(data => data.json());

let user = await bungie.net.platform.user.GetMembershipsForCurrentUser();
console.log('user = %o', user);
let bungieNetUser = user.Response.bungieNetUser;
document.body.appendChild(document.createElement('h1')).textContent = 'Bungie User';
document.body.appendChild(document.createElement('img')).src = `https://www.bungie.net${bungieNetUser.profilePicturePath}`;
document.body.appendChild(document.createTextNode(bungieNetUser.displayName));
document.body.appendChild(document.createElement('br'));

let membership;
for (membership of user.Response.destinyMemberships)
  if (membership.membershipId == user.Response.primaryMembershipId)
    break;
console.log('membership = %o', membership);
document.body.appendChild(document.createElement('h1')).textContent = 'Platform User';
document.body.appendChild(document.createElement('img')).src = `https://www.bungie.net${membership.iconPath}`;
document.body.appendChild(document.createTextNode(membership.displayName));
document.body.appendChild(document.createElement('br'));

let profile = await bungie.net.platform.destiny2[membership.membershipType].profile[membership.membershipId](
    {components: 'Profiles,VendorReceipts,ProfileInventories,ProfileCurrencies,ProfileProgression,Characters,CharacterInventories,CharacterProgressions,CharacterEquipment'});
console.log('profile = %o', profile);
document.body.appendChild(document.createElement('h1')).textContent = 'Characters';
for (let [characterId, character] of Object.entries(profile.Response.characters.data)) {
  document.body.appendChild(document.createElement('img')).src = `https://www.bungie.net${character.emblemPath}`;
  document.body.appendChild(document.createTextNode(character.characterId));
  document.body.appendChild(document.createElement('br'));
  let buckets = {};
  for (let item of profile.Response.characterEquipment.data[character.characterId].items) {
    console.assert(item.transferStatus & 1);
    if (!buckets[item.bucketHash])
      buckets[item.bucketHash] = [];
    buckets[item.bucketHash].push(item);
  }
  for (let item of profile.Response.characterInventories.data[character.characterId].items) {
    console.assert(!(item.tranasferStatus & 1));
    if (!buckets[item.bucketHash])
      buckets[item.bucketHash] = [];
    buckets[item.bucketHash].push(item);
  }
  let ul = document.body.appendChild(document.createElement('ul'));
  for (let [bucketHash, items] of Object.entries(buckets)) {
    let li = ul.appendChild(document.createElement('li'));
    let bucketDef = hashes.DestinyInventoryBucketDefinition[bucketHash];
    li.appendChild(dispDef(bucketDef));
    let ulul = li.appendChild(document.createElement('ul'));
    for (let item of items) {
      let lili = ulul.appendChild(document.createElement('li'));
      let itemDef = hashes.DestinyInventoryItemLiteDefinition[item.itemHash];
      lili.appendChild(dispDef(itemDef));
      lili.appendChild(document.createTextNode(JSON.stringify(item)));
    }
  }
}

function dispDef(def) {
  let div = document.createElement('div');
  if (def.displayProperties.icon)
    div.appendChild(document.createElement('img')).src = `https://www.bungie.net${def.displayProperties.icon}`;
  let title = def.displayProperties.name || def.hash;
  if (def.displayProperties.description)
    title = `${title} \u2022 ${def.displayProperties.description}`;
  div.appendChild(document.createTextNode(title));
  let debug = div.appendChild(document.createElement('span'));
  debug.textContent = ' \u24d8';
  debug.addEventListener('click', e => console.log(def));
  return div;
}


})();
</script>
